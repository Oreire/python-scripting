name: üöÄ Deploy ProjectA to AKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Azure AKS
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: wordpress-rg        # Azure Resource Group containing the AKS cluster
      CLUSTER_NAME: projecta-cluster            # AKS cluster name
      MANIFEST_FILE: week2-projecta-aks.yaml    # Kubernetes manifest file path (inside ./kube)
      NAMESPACE: projecta

    steps:
      # -----------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 2Ô∏è‚É£ Azure Login using Service Principal credentials
      # -----------------------------------------------------
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # -----------------------------------------------------
      # 3Ô∏è‚É£ Configure kubectl to connect to AKS
      # -----------------------------------------------------
      - name: Get AKS credentials
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.RESOURCE_GROUP }}
          cluster-name: ${{ env.CLUSTER_NAME }}

      # -----------------------------------------------------
      # 4Ô∏è‚É£ Validate Kubernetes manifests
      # -----------------------------------------------------
      - name: Validate Kubernetes manifests
        working-directory: ./kube
        run: |
          echo "üîç Validating manifests in kube folder..."
          kubectl apply --dry-run=client -f "${MANIFEST_FILE}"

      # -----------------------------------------------------
      # 5Ô∏è‚É£ Deploy manifests to AKS
      # -----------------------------------------------------
      - name: Apply Kubernetes manifests
        working-directory: ./kube
        run: |
          echo "üöÄ Deploying ProjectA manifests..."
          kubectl apply -f "${MANIFEST_FILE}" --record

      # -----------------------------------------------------
      # 6Ô∏è‚É£ Verify deployment rollout status
      # -----------------------------------------------------
      - name: Verify rollout status
        run: |
          echo "üß† Checking rollout..."
          kubectl rollout status deployment/week2-projecta-server -n "${NAMESPACE}" --timeout=120s

      # -----------------------------------------------------
      # 7Ô∏è‚É£ Display Service and Ingress info
      # -----------------------------------------------------
      - name: Show external endpoints
        run: |
          echo "üåê Fetching Service and Ingress details..."
          kubectl get svc,ing -n "${NAMESPACE}"
